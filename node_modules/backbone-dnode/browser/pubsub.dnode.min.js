(function(){var a=this,b,c,d=a.Store||(a.Store={}),e=a._;!e&&typeof require!="undefined"&&(e=require("underscore")._);var f=a.Backbone;!f&&typeof require!="undefined"&&(f=require("backbone")),e.mixin({getUrl:function(a){if(!a||!a.url)return null;return e.isFunction(a.url)?a.url():a.url}}),b=function(a,b){c=a,e.extend(this,{subscribed:function(a,b){!b.channel||b.finished&&b.finished(a)},unsubscribed:function(a,b){!b.channel||b.finished&&b.finished(a)},published:function(a,b){if(!!b.channel)switch(b.method){case"create":this.created(a,b);break;case"read":this.read(a,b);break;case"update":this.updated(a,b);break;case"delete":this.destroyed(a,b)}}})},e.extend(f.Model.prototype,{url:function(){var a=e.getUrl(this.collection)||this.urlRoot||"";if(this.isNew())return a;return a+(a.charAt(a.length-1)==":"?"":":")+encodeURIComponent(this.id)},publish:function(a,b){if(!c)return a.error&&a.error(503,d,a);var d=this;a||(a={}),a.method||(a.method="update"),a.channel||(a.channel=d.collection?e.getUrl(d.collection):e.getUrl(d)),c.publish(d.toJSON(),a,function(a,c){c.silent||d.trigger("publish",d,c),b&&b(a,c)});return this}});var g={connection:c,subscribe:function(a,b){if(!c)return a.error&&a.error(503,f,a);var f=this;a||(a={}),a.channel||(a.channel=f.collection?e.getUrl(f.collection):e.getUrl(f)),!d[a.channel]||a.override?(d[a.channel]=f,c.subscribe(f.toJSON(),a,function(a,c){c.silent||f.trigger("subscribe",f,c),b&&b(a,c)})):(a.silent||f.trigger("subscribe",f,a),b&&b(f,a));return this},unsubscribe:function(a,b){if(!c)return a.error&&a.error(503,f,a);var f=this;a||(a={}),a.channel||(a.channel=f.collection?e.getUrl(f.collection):e.getUrl(f)),c.unsubscribe({},a,function(a,c){c.silent||f.trigger("unsubscribe",f,c),b&&b(a,c)}),delete d[a.channel];return this}};e.extend(f.Model.prototype,g),e.extend(f.Collection.prototype,g),typeof exports!="undefined"?module.exports=b:a.pubsub=b})()