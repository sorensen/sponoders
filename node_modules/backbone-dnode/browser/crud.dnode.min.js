(function(){var a=this,b,c,d=a.Store||(a.Store={}),e=a._;!e&&typeof require!="undefined"&&(e=require("underscore")._);var f=a.Backbone;!f&&typeof require!="undefined"&&(f=require("backbone")),b=function(a,b){c=a,e.extend(this,{created:function(a,b){a=e.getMongoId(a);var c=d[b.channel];c instanceof f.Model?c.set(c.parse(a)):c instanceof f.Collection&&(c.get(a.id)||c.add(c.parse(a))),b.finished&&b.finished(a)},read:function(a,b){a=e.getMongoId(a);var c=d[b.channel];c instanceof f.Model?c.set(c.parse(a)):c instanceof f.Collection&&(e.isArray(a)?c.reset(c.parse(a)):c.get(a.id)||c.add(c.parse(a))),b.finished&&b.finished(a)},updated:function(a,b){a=e.getMongoId(a);var c=d[b.channel];c.get(a.id)?c.get(a.id).set(c.parse(a)):c.set(c.parse(a)),b.finished&&b.finished(a)},destroyed:function(a,b){a=e.getMongoId(a),d[b.channel].remove(a)||delete d[b.channel],b.finished&&b.finished(a)}})},e.mixin({getMongoId:function(a){a._id&&(a.id=a._id),e.isArray(a)&&e.each(a,function(b,c){b.id&&!b._id&&(a[c]._id=b.id),a[c].id=b._id});return a},sync:function(a,b,d){if(!c)return d.error&&d.error(503,b,d);b.attributes&&b.attributes._id&&delete b.attributes.id,d.type||(d.type=b.type||b.collection.type),d.url||(d.url=e.getUrl(b)),d.channel||(d.channel=b.collection?e.getUrl(b.collection):e.getUrl(b)),d.method||(d.method=a);switch(a){case"read":c.read({},d);break;case"create":c.create(b.toJSON(),d);break;case"update":c.update(b.toJSON(),d);break;case"delete":c.destroy(b.toJSON(),d)}}}),typeof exports!="undefined"?module.exports=b:a.crud=b})()